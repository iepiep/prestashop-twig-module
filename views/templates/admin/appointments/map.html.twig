{#
/**
 *  Copyright (c) 2025 iepiep <r.minini@solution61.fr>
 *
 *  This source file is subject to the MIT license that is bundled
 *  with this source code in the file LICENSE.
 */
#}

{% extends '@PrestaShop/Admin/layout.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-header-title">
                        {{ 'Appointment Map'|trans({}, 'Modules.Dimsymfony.Admin') }}
                    </h3>
                    <div class="toolbar-icons">
                        <a href="{{ path('admin_dimsymphony_gestionrdv_view', {'id': appointment.id_dim_rdv}) }}" class="btn btn-outline-secondary">
                            <i class="material-icons">arrow_back</i>
                            {{ 'Back to details'|trans({}, 'Modules.Dimsymfony.Admin') }}
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h4>{{ 'Location Information'|trans({}, 'Modules.Dimsymfony.Admin') }}</h4>
                            <p>
                                <strong>{{ 'Address:'|trans({}, 'Modules.Dimsymfony.Admin') }}</strong> 
                                {{ appointment.address }}, {{ appointment.postal_code }} {{ appointment.city }}
                            </p>
                            <p>
                                <strong>{{ 'Client:'|trans({}, 'Modules.Dimsymfony.Admin') }}</strong> 
                                {{ appointment.firstname }} {{ appointment.lastname }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h4>{{ 'Appointment Time'|trans({}, 'Modules.Dimsymfony.Admin') }}</h4>
                            <p>
                                <strong>{{ 'Preferred:'|trans({}, 'Modules.Dimsymfony.Admin') }}</strong> 
                                {{ appointment.date_creneau1 }}
                            </p>
                            <p>
                                <strong>{{ 'Alternative:'|trans({}, 'Modules.Dimsymfony.Admin') }}</strong> 
                                {{ appointment.date_creneau2 }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div id="map"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        function initMap() {
            // Get the address from the appointment
            var address = "{{ appointment.address }}, {{ appointment.postal_code }} {{ appointment.city }}, France";
            
            // Initialize the map centered on France
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: {lat: 46.603354, lng: 1.888334} // France center
            });
            
            // Create a geocoder to convert address to coordinates
            var geocoder = new google.maps.Geocoder();
            
            geocoder.geocode({'address': address}, function(results, status) {
                if (status === 'OK') {
                    // Center the map on the address
                    map.setCenter(results[0].geometry.location);
                    
                    // Add a marker for the address
                    var marker = new google.maps.Marker({
                        map: map,
                        position: results[0].geometry.location,
                        title: "{{ appointment.firstname }} {{ appointment.lastname }}"
                    });
                    
                    // Add an info window with client details
                    var infoWindow = new google.maps.InfoWindow({
                        content: '<div>' +
                            '<h5>{{ appointment.firstname }} {{ appointment.lastname }}</h5>' +
                            '<p>{{ appointment.address }}, {{ appointment.postal_code }} {{ appointment.city }}</p>' +
                            '<p>{{ 'Phone:'|trans({}, 'Modules.Dimsymfony.Admin') }} {{ appointment.phone }}</p>' +
                            '<p>{{ 'Email:'|trans({}, 'Modules.Dimsymfony.Admin') }} {{ appointment.email }}</p>' +
                            '</div>'
                    });
                    
                    marker.addListener('click', function() {
                        infoWindow.open(map, marker);
                    });
                    
                    // Open the info window by default
                    infoWindow.open(map, marker);
                } else {
                    console.error('Geocode was not successful for the following reason: ' + status);
                    alert('{{ 'Could not locate the address on the map.'|trans({}, 'Modules.Dimsymfony.Admin') }}');
                }
            });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ googleApiKey }}&callback=initMap"></script>
{% endblock %}
